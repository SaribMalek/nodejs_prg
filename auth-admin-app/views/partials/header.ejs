<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/custom.css">
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
  <div class="container">

    <a class="navbar-brand" href="/dashboard">Admin</a>

    <!-- Mobile Toggle -->
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="mainNavbar">
      <ul class="navbar-nav ms-auto align-items-center">

        <% if (user) { %>

          <li class="nav-item">
            <a class="nav-link" href="/profile">Hi, <%= user.name %></a>
          </li>

          <% if (user.role === 'admin') { %>
            <li class="nav-item"><a class="nav-link" href="/admin/users">Users</a></li>
          <% } %>

          <!-- Visible, styled Logout button (uses JS POST) -->
          <li class="nav-item ms-2">
            <!-- Visible button to avoid form/CSS issues -->
            <button id="logoutBtn" class="btn btn-outline-light btn-sm">Logout</button>
          </li>

        <% } else { %>

          <li class="nav-item"><a class="nav-link" href="/login">Login</a></li>
          <li class="nav-item"><a class="nav-link" href="/register">Register</a></li>

        <% } %>

      </ul>
    </div>

  </div>
</nav>

<div class="container">

  <% if (success && success.length) { %>
    <div class="alert alert-success"><%= success[0] %></div>
  <% } %>
  <% if (error && error.length) { %>
    <div class="alert alert-danger"><%= error[0] %></div>
  <% } %>

<!-- Logout JS: sends POST /logout and redirects to /login on success -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById('logoutBtn');
  if (!btn) return;

  btn.addEventListener('click', async () => {
    try {
      btn.disabled = true;
      // POST to /logout; server should destroy session and redirect or we redirect client
      const resp = await fetch('/logout', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
      // if server returns a redirect (302) the fetch will show 200; safe to redirect client:
      window.location.href = '/login?loggedout=1';
    } catch (err) {
      console.error('Logout failed', err);
      // fallback: try GET logout
      window.location.href = '/logout';
    } finally {
      btn.disabled = false;
    }
  });
});
</script>
