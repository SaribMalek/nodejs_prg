<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Real-Time Notifications Demo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link href="/css/styles.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container">
    <a class="navbar-brand" href="/">NotifDemo</a>
    <div class="ms-auto d-flex align-items-center">
      <div class="dropdown me-3">
        <button class="btn btn-light position-relative" id="notifToggle" data-bs-toggle="dropdown" aria-expanded="false">
          ðŸ”” <span id="notifCountBadge" class="badge bg-danger position-absolute top-0 start-100 translate-middle">0</span>
        </button>
        <ul class="dropdown-menu dropdown-menu-end p-2" style="min-width:320px;" id="notifList">
          <li class="text-muted">No notifications</li>
        </ul>
      </div>
      <div class="me-3 text-white">
        User: <strong id="userIdDisplay"><%= userId ? userId : 'Guest' %></strong>
      </div>
      <a class="btn btn-light refresh_btn" href="/">Refresh</a>
    </div>
  </div>
</nav>

<div class="container py-4">
  <h3>Send Notification (Demo admin)</h3>
  <p class="text-muted">Use this to simulate sending notifications to one user or broadcast.</p>

  <form id="notifyForm" class="row g-2">
    <div class="col-md-3">
      <input type="number" class="form-control" id="inputUserId" placeholder="userId (empty = broadcast)">
    </div>
    <div class="col-md-3">
      <input type="text" class="form-control" id="inputTitle" placeholder="Title" required>
    </div>
    <div class="col-md-4">
      <input type="text" class="form-control" id="inputMessage" placeholder="Message" required>
    </div>
    <div class="col-md-2">
      <button class="btn btn-primary w-100" type="submit">Send</button>
    </div>
  </form>

  <hr>

  <h5>Recent notifications</h5>
  <ul id="initialList" class="list-group mb-4">
    <% if (notifications && notifications.length) { %>
      <% notifications.forEach(function(n){ %>
        <li class="list-group-item d-flex justify-content-between align-items-start">
          <div>
            <div class="fw-bold"><%= n.title %></div>
            <div><%= n.message %></div>
            <small class="text-muted"><%= new Date(n.created_at).toLocaleString() %></small>
          </div>
          <div>
            <% if (!n.is_read) { %>
              <button data-id="<%= n.id %>" class="btn btn-sm btn-outline-secondary markReadBtn">Mark read</button>
            <% } else { %>
              <span class="badge bg-success">Read</span>
            <% } %>
          </div>
        </li>
      <% }) %>
    <% } else { %>
      <li class="list-group-item text-muted">No recent notifications</li>
    <% } %>
  </ul>

  <p class="text-muted">Tip: open two browser windows with different ?userId=1 and ?userId=2 to test personal notifications.</p>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/notifications.js"></script>

<script>
  // pass server-rendered userId to client script
  window.APP = {
    userId: <%= userId ? userId : 'null' %>
  };

  // initial render: compute badge count from notifications not read
  $(function(){
    const initialUnread = <%= notifications ? notifications.filter(n => n.is_read == 0).length : 0 %>;
    updateBadge(initialUnread);
  });
</script>
</body>
</html>
